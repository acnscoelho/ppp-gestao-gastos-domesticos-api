name: API Gestão Gastos Domésticos - Tests

'on':
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch: null

jobs:
  api-tests:
    name: Testes de API (Mocha)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: npm

      - name: Instalar dependências
        run: npm ci

      - name: Iniciar servidor da API
        run: npm start &

      - name: Aguardar API iniciar
        run: sleep 10

      - name: Executar testes de API
        run: npm test
        env:
          NODE_ENV: test

      - name: Upload do relatório Mochawesome
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mochawesome-report
          path: mochawesome-report/

  performance-tests:
    name: Testes de Performance (JMeter)
    runs-on: ubuntu-latest
    needs: api-tests
    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: npm

      - name: Instalar dependências
        run: npm ci

      - name: Instalar JMeter
        run: >
          wget
          https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz

          tar -xzf apache-jmeter-5.6.3.tgz

          echo "$PWD/apache-jmeter-5.6.3/bin" >> $GITHUB_PATH

      - name: Criar usuário de teste
        run: |
          npm start &
          sleep 5
          curl -X POST http://localhost:3000/api/users/register \
            -H "Content-Type: application/json" \
            -d '{"name":"Performance Test","email":"performance@test.com","password":"123456"}'

      - name: Executar teste de performance com JMeter
        run: |
          jmeter -n -t test/performance/jmeter/login-performance-test.jmx \
            -l test/performance/results/results.jtl \
            -e -o test/performance/results/html-report
        env:
          NEW_RELIC_LICENSE_KEY: '${{ secrets.NEW_RELIC_LICENSE_KEY }}'
          NEW_RELIC_ACCOUNT_ID: '${{ secrets.NEW_RELIC_ACCOUNT_ID }}'

      - name: Upload do relatório JMeter
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report
          path: test/performance/results/html-report/
